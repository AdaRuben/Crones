const app = require('./app');
const { GigaChat } = require('gigachat');
const { Agent } = require('node:https');
require('dotenv').config();

const httpsAgent = new Agent({
  rejectUnauthorized: false,
});

const client = new GigaChat({
  timeout: 10000,
  model: 'GigaChat-2',
  credentials: process.env.GIGACHAT_API_KEY,
  httpsAgent,
});

const SYSTEM_PROMPT = `Ты — расчётчик стоимости эвакуации. Верни только одну строку строго в формате:
"Стоимость услуги: X рублей."

Вход: строка с дистанцией (например, "12 км 300 м" или "12,6 км") и тип авто.

Округление дистанции:
- Извлеки километры и метры (допускаются десятичные км и запятая).
- Если есть метры:
  - если метры >= 500 — округли километры вверх;
  - иначе — округли километры вниз.
- Если метров нет, но километры дробные — округли вниз до целого.
- Результат — целое число километров, не меньше нуля.

Нормализация типа авто:
- "Седан" и "Кроссовер" трактуй как "Седан/Кроссовер".
- "Внедорожник" — отдельная категория.

Тариф (без выезда):
- Седан/Кроссовер:
  - если км <= 15 → 3500;
  - если км > 15 → 3000 + 500 * (км - 15).
- Внедорожник:
  - если км <= 15 → 4000;
  - если км > 15 → 3500 + 550 * (км - 15).

Итог:
- Стоимость выезда: 4000.
- Итого = 4000 + тариф.

Формат ответа:
- Верни строго: "Стоимость услуги: <целое_число> рублей." — без пояснений, без лишних символов, число без пробелов и разделителей.

Примеры:
- "Дистанция: 12 км 600 м. Тип авто: Седан/Кроссовер." → 13 км → тариф 3500 → Итого 7500 → "Стоимость услуги: 7500 рублей."
- "Дистанция: 18 км. Тип авто: Внедорожник." → 18 км → тариф 3500 + 550*3 = 5150 → Итого 9150 → "Стоимость услуги: 9150 рублей."
- "Дистанция: 12,6 км. Тип авто: Седан." → дробные км без метров → округление вниз → 12 км → тариф 3500 → Итого 7500 → "Стоимость услуги: 7500 рублей."
`;

app.post('/api/chat', async (req, res) => {
  try {
    const { message } = req.body;
    if (!message) {
      return res.status(400).json({ error: 'Сообщение нет' });
    }

    const response = await client.chat({
      messages: [
        { role: 'system', content: SYSTEM_PROMPT },
        { role: 'user', content: message },
      ],
    });

    const aiResponse =
      response.choices?.[0]?.message?.content || 'Ошибка генерации ответа';
    res.json(aiResponse);
  } catch (error) {
    console.error('Детальная ошибка:', error);
    return res.status(500).json({
      error: 'Ошибка сервера при обработке запроса',
      details: error.message,
    });
  }
});
